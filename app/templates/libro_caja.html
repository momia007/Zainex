 <!-- ..templates/libro_caja.html -->
{% extends 'base.html' %}
{% import 'partials/moneda_arg.html' as moneda %}

{% block titulo %}
  üìò Libro Caja
{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/libro_caja.css') }}">
{% endblock %}

{% block encabezado %}
  {{ current_user.nombre }} est√°s viendo el estado contable üìä
{% endblock %}

{% block content %}
  <h2>üìñ Registro contable</h2>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }}">{{ message }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <table class="libro-caja">
    <thead>
      <tr>
        <th>Fecha</th>
        <th>Detalle</th>
        <th>Rubro</th>
        <th>Comprobante</th>
        <th style="color:green;">Cr√©dito</th>
        <th style="color:red;">D√©bito</th>
        <th>üí∞ Saldo acumulado</th>
        <th>Conciliado</th>
      </tr>
    </thead>

    <tbody>
        {% for mov in transacciones %}
          {% set credito = mov.importe_mov if mov.tipo_mov == 'Ingreso' else 0 %}
          {% set debito = mov.importe_mov if mov.tipo_mov == 'Egreso' else 0 %}

          <tr>
            <td data-label="Fecha">{{ mov.fecha_mov.strftime('%d/%m/%Y') }}</td>
            <td data-label="Detalle">
              <span {% if mov.observaciones_mov %}title="{{ mov.observaciones_mov }}"{% endif %}>
                {{ mov.detalle_mov }}
              </span>
            </td>
            <td data-label="Rubro">{{ mov.rubro_mov }}</td>
            <td data-label="Comprobante">
              {% if mov.url_comprob_mov %}
                {% if mov.url_comprob_mov.endswith('.pdf') %}
                  <a href="{{ mov.url_comprob_mov }}" target="_blank">üìÑ PDF</a>
                {% else %}
                  <a href="{{ mov.url_comprob_mov }}" target="_blank">
                    <img src="{{ mov.url_comprob_mov }}" alt="Comprobante" style="max-height: 40px;">
                  </a>
                {% endif %}
              {% else %}
                {{ mov.comprobante_mov or '‚Äî' }}
              {% endif %}
            </td>
            <td data-label="Cr√©dito" style="color:green;">{{ moneda.formato_monto(credito) }}</td>
            <td data-label="D√©bito" style="color:red;">{{ moneda.formato_monto(debito) }}</td>
            <td data-label="Saldo"><strong>{{ moneda.formato_monto(mov.saldo_actual) }}</strong></td>
            <td data-label="Conciliado">
              {% if mov.conciliado_mov %}
                ‚úÖ
              {% else %}
                ‚ùå
              {% endif %}
            </td>

          </tr>
        {% endfor %}
    </tbody>

  </table>

  <button onclick="window.location.href='/nvo_movimiento'">‚ûï Registrar Movimiento</button>
  <button onclick="window.location.href='/conciliar'">üîÑ Conciliaci√≥n Bancaria</button>
  <button onclick="irHome()">Cancelar</button>
  <!-- Modal emergente para ver detalles -->
  <div id="modal-movimiento" class="modal">
    <div class="modal-contenido">
      <span class="cerrar" onclick="cerrarModal()">&times;</span>
      <h3>üìÑ Detalles del Movimiento</h3>
      <ul id="datos-movimiento"></ul>
    </div>
  </div>

  <script>
    function mostrarDetalles(mov) {
      const contenedor = document.getElementById('datos-movimiento');
      let comprobanteHTML = mov.comprobante_mov;

      // Si hay URL y es imagen, mostrar miniatura
      if (mov.url_comprob_mov) {
        const esImagen = /\.(jpg|jpeg|png|gif)$/i.test(mov.url_comprob_mov);
        const esPDF = /\.pdf$/i.test(mov.url_comprob_mov);

        if (esImagen) {
          comprobanteHTML += `<br><img src="${mov.url_comprob_mov}" alt="Comprobante" style="max-width: 100%; margin-top: 8px;">`;
        } else if (esPDF) {
          comprobanteHTML += `<br><iframe src="${mov.url_comprob_mov}" width="100%" height="400px" style="margin-top: 8px;"></iframe>`;
        } else {
          comprobanteHTML += `<br><a href="${mov.url_comprob_mov}" target="_blank">üìÑ Ver archivo</a>`;
        }
      }


      contenedor.innerHTML = `
        <li><strong>Fecha:</strong> ${mov.fecha_mov}</li>
        <li><strong>Detalle:</strong> ${mov.detalle_mov}</li>
        <li><strong>Rubro:</strong> ${mov.rubro_mov}</li>
        <li><strong>Tipo:</strong> ${mov.tipo_mov}</li>
        <li><strong>Importe:</strong> $${parseFloat(mov.importe_mov).toFixed(2)}</li>
        <li><strong>Comprobante:</strong> ${comprobanteHTML}</li>
        <li><strong>Conciliado:</strong> ${mov.conciliado_mov == 1 ? 'S√≠' : 'No'}</li>
        <li><strong>Observaciones:</strong> ${mov.observaciones_mov || '‚Äî'}</li>
      `;
      document.getElementById('modal-movimiento').style.display = 'block';
    }

    function cerrarModal() {
      document.getElementById('modal-movimiento').style.display = 'none';
    }

    window.onclick = function(event) {
      const modal = document.getElementById('modal-movimiento');
      if (event.target == modal) {
        cerrarModal();
      }
    }

    function irHome() {
      window.location.href = '/home';
    }
  </script>
{% endblock %}
