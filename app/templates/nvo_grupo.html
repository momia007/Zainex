<!-- ../templates/nvo_grupo.html -->
{% extends 'base.html' %}

{% block titulo %}Nuevo Grupo{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/grupo.css') }}">
{% endblock %}

{% block encabezado %}
üß© Crear Nuevo Grupo
{% endblock %}

{% block content %}
  <div class="alerta_error">
    {% if mensaje == 'grupo_duplicado' %}
      <p style="color: red;">‚ö†Ô∏è Ya existe un grupo con ese n√∫mero. Por favor, eleg√≠ otro.</p>
    {% elif mensaje == 'numero_invalido' %}
      <p style="color: red;">‚ö†Ô∏è El n√∫mero de grupo debe ser num√©rico.</p>
    {% elif mensaje == 'numero_largo' %}
      <p style="color: red;">‚ö†Ô∏è El n√∫mero de grupo no puede tener m√°s de 6 d√≠gitos.</p>
    {% elif mensaje == 'nombre_vacio' %}
      <p style="color: red;">‚ö†Ô∏è El nombre no puede estar vac√≠o.</p>
    {% elif mensaje == 'distrito_invalido' %}
      <p style="color: red;">‚ö†Ô∏è El distrito debe ser num√©rico.</p>
    {% elif mensaje == 'distrito_largo' %}
      <p style="color: red;">‚ö†Ô∏è El distrito no puede tener m√°s de 6 d√≠gitos.</p>
    {% elif mensaje == 'zona_invalida' %}
      <p style="color: red;">‚ö†Ô∏è La zona debe ser num√©rica.</p>
    {% elif mensaje == 'zona_larga' %}
      <p style="color: red;">‚ö†Ô∏è La zona no puede tener m√°s de 6 d√≠gitos.</p>
    {% endif %}
  </div>

  <div class="formulario">
    <form id="form-funcion" method="POST" action="{{ url_for('admin.guardar_grupo') }}">
      <label for="numero">N√∫mero:</label>
      <input type="text" id="numero" name="numero" required oninput="verificarGrupo(this.value)" />
      <div id="mensaje_grupo" class="mensaje-validacion"></div>

      <label for="nombre">Nombre del Grupo:</label>
      <input type="text" id="nombre" name="nombre" required />

      <label for="distrito">Nro. Distrito:</label>
      <input type="number" id="distrito" name="distrito" required />

      <label for="zona">Nro. Zona:</label>
      <input type="number" id="zona" name="zona" required />

      <button type="submit" id="btn_guardar">üíæ Guardar</button>
      <button type="button" onclick="irHome()">Cancelar</button>
    </form>

    <div id="popup" style="display: none;">
      <p>üéâ Grupo creado correctamente.</p>
      <button onclick="cargarOtra()">Cargar Otro</button>
      <button onclick="irHome()">Terminar</button>
    </div>
  </div>

  <script>
    const mensaje = "{{ mensaje | default('') }}";
    if (mensaje === 'ok') {
      document.getElementById('popup').style.display = 'block';
      document.getElementById('btn_guardar').style.display = 'none';
    }

    function verificarGrupo(nombre) {
      if (!nombre.trim()) {
        document.getElementById("mensaje_grupo").textContent = "";
        return;
      }

      fetch(`/admin/existe_grupo/${encodeURIComponent(nombre)}`)
        .then(res => res.json())
        .then(data => {
          const msg = document.getElementById("mensaje_grupo");
          const btn = document.getElementById("btn_guardar");
          if (data.existe) {
            msg.textContent = "‚ö†Ô∏è El grupo ya existe";
            btn.disabled = true;
          } else {
            msg.textContent = "";
            btn.disabled = false;
          }
        });
    }

    function cargarOtra() {
      window.location.href = "{{ url_for('admin.nvo_grupo') }}";
    }

    function irHome() {
      window.location.href = "{{ url_for('admin.home') }}";
    }
  </script>
{% endblock %}
