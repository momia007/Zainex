{% extends 'base.html' %}

{% block titulo %}Nuevo Miembro{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/nvo_miembro.css') }}">
{% endblock %}

{% block encabezado %}
Crear Nuevo Miembro üßë‚Äçü§ù‚Äçüßë
{% endblock %}

{% block content %}
<form id="form-funcion" method="POST" action="{{ url_for('miembros.guardar_miembro') }}" class="formulario">
  <label for="nombre_miembro">Nombre:</label>
  <input type="text" id="nombre_miembro" name="nombre_miembro" required value="{{ request.form.nombre_miembro }}">

  <label for="apellido_miembro">Apellido:</label>
  <input type="text" id="apellido_miembro" name="apellido_miembro" required value="{{ request.form.apellido_miembro }}">

  <label for="fecha_nac_miembro">Fecha de nacimiento:</label>
  <input type="date" id="fecha_nac_miembro" name="fecha_nac_miembro" required onchange="mostrarEdad()" value="{{ request.form.fecha_nac_miembro }}">
  <span id="edad_miembro"></span>

  <label for="email_miembro">Email:</label>
  <input type="email" id="email_miembro" name="email_miembro" required value="{{ request.form.email_miembro }}">

  <label for="rol_miembro">Rol:</label>
  <select id="rol_miembro" name="rol_miembro" required>
    <option value="">Seleccionar</option>
    <option value="miembro" {% if request.form.rol_miembro == 'miembro' %}selected{% endif %}>Miembro</option>
    <option value="coordinador" {% if request.form.rol_miembro == 'coordinador' %}selected{% endif %}>Coordinador</option>
  </select>

  <label for="grupo_miembro">Grupo:</label>
  <input type="number" id="grupo_miembro" name="grupo_miembro" onchange="buscarNombreGrupo(this.value)" value="{{ request.form.grupo_miembro }}">
  <input type="text" id="nombre_grupo" disabled>
  <input type="hidden" id="hidden_nombre_grupo" name="nombre_grupo">

  <!-- Botones de acci√≥n -->
  <button type="submit">Aceptar</button>
  <button type="button" onclick="irHome()">Cancelar</button>
</form>

<!-- Mensajes de error o √©xito -->
{% if mensaje and mensaje != 'ok' %}
  <div class="alerta-error">
    ‚ö† {{ mensaje.replace('_', ' ').capitalize() }}
  </div>
{% endif %}

{% if mensaje == 'ok' %}
<div id="popup" style="display: none;">
  <p>Miembro creado con √©xito</p>
  <button onclick="cargarOtra()">Cargar Otro</button>
  <button onclick="irHome()">Cancelar</button>
</div>
{% endif %}

<script>
  const mensaje = "{{ mensaje | default('') }}";
  if (mensaje === 'ok') {
    document.getElementById('popup').style.display = 'block';
  }

  function cargarOtra() {
    window.location.href = "{{ url_for('miembros.nvo_miembro') }}";
  }

  function irHome() {
    window.location.href = "{{ url_for('admin.home') }}";
  }

  function buscarNombreGrupo(num) {
    if (!num) {
      document.getElementById('nombre_grupo').value = '';
      return;
    }

    fetch(`/admin/grupo_nombre/${num}`)
      .then(response => response.json())
      .then(data => {
        const nombre = data.nombre || 'Grupo no encontrado';
        document.getElementById('nombre_grupo').value = nombre;
        document.getElementById('hidden_nombre_grupo').value = nombre;
      });
  }

  function mostrarEdad() {
    const input = document.getElementById("fecha_nac_miembro").value;
    const edadSpan = document.getElementById("edad_miembro");

    if (input) {
      const fechaNac = new Date(input);
      const hoy = new Date();
      let edad = hoy.getFullYear() - fechaNac.getFullYear();
      const mes = hoy.getMonth() - fechaNac.getMonth();
      const dia = hoy.getDate() - fechaNac.getDate();
      if (mes < 0 || (mes === 0 && dia < 0)) edad--;

      if (edad >= 6) {
        edadSpan.textContent = `Edad: ${edad} a√±os`;
        edadSpan.style.color = "#000";
      } else {
        edadSpan.textContent = `Edad inv√°lida (m√≠nimo 6 a√±os)`;
        edadSpan.style.color = "#aa0000";
      }
    } else {
      edadSpan.textContent = '';
    }
  }
</script>
{% endblock %}
